!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t(e.MHTML={})}(this,function(e){"use strict";function t(e,t,n=0,o=0){return this.childNodes=[],this.firstChild=null,this.lastChild=null,this.startNode=e,this.stopNode=t,e&&t?e.parentNode!==t.parentNode?this:(this.update(),this):this}t.prototype.appendChild=function(e){this.stopNode.parentNode.insertBefore(e,this.stopNode),this.update()},t.prototype.removeChild=function(e){this.stopNode.parentNode.removeChild(e),this.update()},t.prototype.replaceChild=function(e,t){t.parentNode.replaceChild(e,t),this.update()},t.prototype.extractContents=function(){const e=document.createDocumentFragment();return e.appendChild(this.startNode),this.childNodes.reduce((e,t)=>(e.appendChild(t),e),e),e.appendChild(this.stopNode),e},t.prototype.update=function(){this.childNodes=[];for(let e=this.startNode.nextSibling;e&&e!==this.stopNode;e=e.nextSibling)e.range&&(e.range.onUpdate=(()=>this.update())),this.childNodes.push(e);this.firstChild=this.childNodes[0],this.lastChild=this.childNodes[this.childNodes.length-1],this.onUpdate&&this.onUpdate()},t.prototype.getByIndex=function(e){};const n={},o={ELEMENT_NODE:1,ATTRIBUTE_NODE:2,TEXT_NODE:3,CDATA_SECTION_NODE:4,ENTITY_REFERENCE_NODE:5,ENTITY_NODE:6,PROCESSING_INSTRUCTION_NODE:7,COMMENT_NODE:8,DOCUMENT_NODE:9,DOCUMENT_TYPE_NODE:10,DOCUMENT_FRAGMENT_NODE:11,NOTATION_NODE:12};function i(e,t,n=""){return!(!e||!t)&&(e.nodeType===t.nodeType&&(e.range==t.range&&(!(!e.tagName||!t.tagName||e.tagName.toLowerCase().replace(n,"")!==t.tagName.toLowerCase())||e.isEqualNode(t))))}function r(e){return e.replace(/[-[\]{}()*+!<=:?.\/\\^$|#\s,]/g,"\\$&")}function s(e){return e instanceof Node?"element":e instanceof Promise?"futureResult":e instanceof m?"template":e instanceof Function?"function":"text"}function a(e,t,n,o){""!==o&&t in e?e[t]=n:e.setAttribute(t,n)}const p=`modulor_stop_node_${+new Date}`;function c(e){e.nodeStopper=p}const h=`{modulor_html_chunk_${+new Date}:`,d="}",u=new DOMParser,l=`modulor_sanitize_node_${+new Date}:`,N=new RegExp(`<([ /])?(${["table","tr","td"].join("|")})([ ][^]>)?`,"igm");function m(e){return this.PREFIX=e.PREFIX||h,this.POSTFIX=e.POSTFIX||d,this.parser=e.parser||u,this.replaceChunkRegex=new RegExp(this.getTokenRegExp(),"ig"),this.matchChunkRegex=new RegExp(`^${this.getTokenRegExp(!0)}$`),this.sanitizeNodePrefix=e.SANITIZE_NODE_PREFIX||l,this}m.prototype.parse=function(...e){[this.template,this.dataMap]=this.prepareLiterals(...e),this.templateId=function(e){for(var t=5381,n=e.length;n;)t=33*t^e.charCodeAt(--n);return t>>>0}(this.template);const t=n[this.templateId];return void 0===t?(this.container=this.generateContainer(this.sanitize(this.template)),n[this.templateId]=this.container):this.container=t,this},m.prototype.processTextNodeChunks=function(e,t=this.dataMap){return e.reduce((e,n)=>{if(!`${n}`.length)return e;const o=n.match(this.matchChunkRegex),i=o?t[n]:n;if(void 0===i)return e;const r=s(i);if("text"!==r){const t=document.createComment("");return t.isSpecialChunk=!0,t[r]=i,t.chunkType=r,t.templateId=this.templateId,t.chunkId=o[2],e.concat(t)}return e.concat(i)},[])},m.prototype.copyTextNodeChunks=function(e,t=this.dataMap,n=document.createDocumentFragment()){return[].concat(e).reduce((e,t)=>{if(t.isSpecialChunk)return e.appendChild(t),e;const n=s(t);if("text"===n)e.appendChild(document.createTextNode(t));else{const o=document.createComment("");o[n]=t,o.isSpecialChunk=!0,o.chunkType=n,o.templateId=this.templateId,e.appendChild(o)}return e},n)},m.prototype.copyAttributes=function(e,t,n=this.dataMap){const o=[],i=t.attributes;if(!i.length)return;for(let t=0;t<i.length;t++){const{name:r,value:p}=i[t],c=this.matchChunkRegex.test(r)?n[r]:this.replaceTokens(r),h=this.matchChunkRegex.test(p)?n[p]:this.replaceTokens(p);if(""===c)return;"function"!==s(c)?(o.push(c),"futureResult"!==s(h)?a(e,c,h,p):h.then(t=>a(e,c,t))):c(e,h)}const r=e.attributes;for(let t=0;t<r.length;t++){const n=r[t].name;~o.indexOf(n)||e.removeAttribute(n)}},m.prototype.loop=function(e,n,r){for(let r=0,c=0;;r++){if(r>1e3){console.log("too much recursion");break}const h=e.childNodes[r],d=n.childNodes[r+c];if(!h&&!d)break;if(h)if(d&&i(h,d,this.sanitizeNodePrefix))a=d,((s=h).nodeType!==o.TEXT_NODE||s.nodeType!==o.TEXT_NODE||s.textContent!==a.textContent)&&i(h,d,this.sanitizeNodePrefix)&&(d.nodeStopper!==p&&this.loop(h,d),this.copyAttributes(d,h));else{const e=((e,t)=>n=>t?e.replaceChild(n,t):e.appendChild(n))(n,d),i=(n,o)=>{if(n&&n.range&&n.replacementType===o&&n.templateId===this.templateId)return n.range;{const n=new t(document.createTextNode(""),document.createTextNode("")),{startNode:i}=n;return i.range=n,i.replacementType=o,i.templateId=this.templateId,e(n.extractContents()),n}};switch(h.nodeType){case o.TEXT_NODE:const t=h.textContent.split(this.replaceChunkRegex);if(1===t.length){e(document.createTextNode(h.textContent));break}let n=i(d,"textContent");const r=this.processTextNodeChunks(t),s=this.copyTextNodeChunks(r);this.loop(s,n),c+=n.childNodes.length+1;break;case o.COMMENT_NODE:if(h.isSpecialChunk){const e=h.chunkType,t=i(d,e);if("futureResult"===e){t.update(),h.futureResult.then(e=>{t.update();const n=this.copyTextNodeChunks(e);return this.loop(n,t),n}),c+=t.childNodes.length+1;break}if("template"===e){h.template.render(t),c+=t.childNodes.length+1;break}if("element"===e){const e=document.createDocumentFragment();e.appendChild(h.element),this.loop(e,t),c+=t.childNodes.length+1;break}}e(document.createComment(this.replaceTokens(h.textContent)));break;case o.ELEMENT_NODE:const a=document.createElement(h.tagName.toLowerCase().replace(this.sanitizeNodePrefix,""));this.loop(h,a),e(a),this.copyAttributes(a,h)}}else n.removeChild(d),r--}var s,a;return n},m.prototype.render=function(e=document.createDocumentFragment()){return c(e),this.loop(this.container,e)},m.prototype.generateContainer=function(e){return this.parser.parseFromString(e,"text/html").body},m.prototype.sanitize=function(e){return e.replace(N,`<$1${this.sanitizeNodePrefix}$2`)},m.prototype.prepareLiterals=function([e,...t],...n){return t.reduce(([e,t],o,i)=>{const r=this.generateTokenName(i);return t[r]=n[i],[e.concat(r).concat(o),t]},[e,{}])},m.prototype.generateTokenName=function(e){return`${this.PREFIX}${e}${this.POSTFIX}`},m.prototype.replaceTokens=function(e,t=this.dataMap){return e.replace(this.replaceChunkRegex,(e,n)=>t[e])},m.prototype.getTokenRegExp=function(e){const t=`${e?"(":""}\\d+${e?")":""}`;return`(${r(this.PREFIX)}${t}${r(this.POSTFIX)})`};const f=(...e)=>new m({}).parse(...e),T=(e,t)=>e.render(t);e.stopNode=c,e.Template=m,e.html=f,e.render=T,e.r=((...e)=>T(f(...e))),Object.defineProperty(e,"__esModule",{value:!0})});
