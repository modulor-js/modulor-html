!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t(e.MHTML={})}(this,function(e){"use strict";function t(e,t){return this.childNodes=[],this.firstChild=null,this.lastChild=null,this.startNode=e,this.stopNode=t,e&&t?e.parentNode!==t.parentNode?this:(this.update(),this):this}t.prototype.appendChild=function(e){this.stopNode.parentNode.insertBefore(e,this.stopNode),this.update()},t.prototype.removeChild=function(e){this.stopNode.parentNode.removeChild(e),this.update()},t.prototype.replaceChild=function(e,t){t.parentNode.replaceChild(e,t),this.update()},t.prototype.extractContents=function(){var e=document.createDocumentFragment();return e.appendChild(this.startNode),this.childNodes.reduce(function(e,t){return e.appendChild(t),e},e),e.appendChild(this.stopNode),e},t.prototype.update=function(){var e=this;this.childNodes=[];for(var t=this.startNode.nextSibling;t&&t!==this.stopNode;t=t.nextSibling)t.range&&(t.range.onUpdate=function(){return e.update()}),this.childNodes.push(t);this.firstChild=this.childNodes[0],this.lastChild=this.childNodes[this.childNodes.length-1],this.onUpdate&&this.onUpdate()},t.prototype.getByIndex=function(e){};var n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};var r={},o={TEMPLATE_NODE:-1,TEXT_RESULT_NODE:-2,PROMISE_NODE:-3,ELEMENT_RESULT_NODE:-4,ELEMENT_NODE:1,ATTRIBUTE_NODE:2,TEXT_NODE:3,CDATA_SECTION_NODE:4,ENTITY_REFERENCE_NODE:5,ENTITY_NODE:6,PROCESSING_INSTRUCTION_NODE:7,COMMENT_NODE:8,DOCUMENT_NODE:9,DOCUMENT_TYPE_NODE:10,DOCUMENT_FRAGMENT_NODE:11,NOTATION_NODE:12};function i(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"";return!(!e||!t)&&(e.nodeType===t.nodeType&&(e.range==t.range&&(!(!e.tagName||!t.tagName||e.tagName.toLowerCase().replace(n,"")!==t.tagName.toLowerCase())||e.isEqualNode(t))))}function a(e){return void 0!==e}function u(e){return e.replace(/[-[\]{}()*+!<=:?.\/\\^$|#\s,]/g,"\\$&")}function s(e){return e instanceof Node?"element":e instanceof y?"template":!(t=e)||"object"!==(void 0===t?"undefined":n(t))&&"function"!=typeof t||"function"!=typeof t.then?"function"==typeof e?"function":"text":"futureResult";var t}function c(e,t,n){""!==n&&"style"!==t&&t in e?e[t]=n:e.setAttribute(t,n)}var d="{modulor_html_chunk_"+ +new Date+":",l="}",p=new DOMParser,h="modulor_sanitize_node_"+ +new Date+":",f=new RegExp("<([ /])?("+["table","tr","td"].join("|")+")([ ][^]>)?","igm"),E=new Map;function N(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=e.PREFIX||d,N=e.POSTFIX||l,m=e.parser||p,v=new RegExp(R(),"ig"),T=new RegExp(R(),"ig"),y=new RegExp(R(!0),"ig"),g=new RegExp("^"+R(!0)+"$"),_=e.SANITIZE_NODE_PREFIX||h;function O(e){return(arguments.length>1&&void 0!==arguments[1]?arguments[1]:[])[e]}function C(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];return e.replace(y,function(e,n,r){var o=O(r,t);return a(o)?o:""})}function D(){return{childNodes:(arguments.length>0&&void 0!==arguments[0]?arguments[0]:[]).map(function(e){return{nodeType:o.TEXT_RESULT_NODE,textContent:e}})}}function b(e){return m.parseFromString(e,"text/html").body}function x(e){var t,r=(t=e,Array.isArray(t)?t:Array.from(t)),o=r[0];return r.slice(1).reduce(function(e,t,r){var o=function(e){return""+n+e+N}(r);return e.concat(o).concat(t)},o)}function R(e){var t=(e?"(":"")+"\\d+"+(e?")":"");return"("+u(n)+t+u(N)+")"}function I(e){return e.replace(f,"<$1"+_+"$2")}function M(e){return{childNodes:[].concat(e).reduce(function(e,t){if(!a(t))return e;var n=s(t),r={};return"text"===n&&(r.nodeType=o.TEXT_RESULT_NODE,r.textContent=t),"element"===n&&(r.nodeType=o.ELEMENT_RESULT_NODE),"template"===n&&(r.nodeType=o.TEMPLATE_NODE),"futureResult"===n&&(r.nodeType=o.PROMISE_NODE),r[n]=t,e.concat(r)},[])}}function S(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];this.prevValues=[];for(var t=arguments.length,n=Array(t>1?t-1:0),o=1;o<t;o++)n[o-1]=arguments[o];if(this.values=n,this.template=x(e),!this.template)return this;this.templateId=function(e){for(var t=5381,n=e.length;n;)t=33*t^e.charCodeAt(--n);return t>>>0}(this.template);var i=r[this.templateId];return a(i)?this.container=i:(this.container=b(I(this.template)),r[this.templateId]=this.container),this.updates=[],this}return S.prototype.render=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:document.createDocumentFragment(),t=E.get(e);if((t||{}).templateId!==this.templateId)return E.set(e,{templateId:this.templateId,update:this.update.bind(this)}),this.loop(this.container,e);t.update(this.values)},S.prototype.update=function(e){this.prevValues=this.values,this.values=e,this.updates.forEach(function(e){return e()})},S.prototype.copyAttributes=function(e,t){for(var n=this,r=t.attributes,o=e.attributes,i=[],a={},u=function(t){var o=r[t],u=o.name,d=o.value,l=u.match(T),p=d.match(T);if(a[u]=!0,!l&&!p)return c(e,u,d),"continue";if("class"===u)return e.className="",d.split(" ").forEach(function(t){t.match(T)?i.push(function(){var r=C(t,n.values),o=C(t,n.prevValues);o!==r&&(o&&e.classList.remove(o),r&&e.classList.add(r))}):e.classList.add(t)}),"continue";var h=u.match(g),f=d.match(g);i.push(function(){var t=h?O(h[2],n.values):C(u,n.values),r=h?O(h[2],n.prevValues):C(u,n.prevValues),o=f?O(f[2],n.values):C(d,n.values),i=f?O(f[2],n.prevValues):C(d,n.prevValues);t===r&&o===i||(t!==r&&e.removeAttribute(r),t&&("function"!==s(t)?"futureResult"!==s(o)?c(e,t,o):o.then(function(n){return c(e,t,n)}):t(e,o)))})},d=0;d<r.length;d++)u(d);for(d=0;d<o.length;d++){var l=o[d].name;a[l]||e.removeAttribute(l)}return i.forEach(function(e){return e()}),i},S.prototype.loop=function(e,n){for(var r,a,u=this,s=document.createDocumentFragment(),c=e.childNodes,d=function(e){return e?function(t){return n.replaceChild(t,e)}:function(e){return s.appendChild(e)}},l=0,p=0;;l++){var h=c[l],f=n.childNodes[l+p];if(!h&&!f){n.appendChild(s);break}if(h){if(!f||!i(h,f,_))if("continue"===function(){var e=d(f),r=function(n,r){if(n&&n.range&&n.replacementType===r)return n.range;var o=new t(document.createTextNode(""),document.createTextNode("")),i=o.startNode;return i.range=o,i.replacementType=r,e(o.extractContents()),o};switch(h.nodeType){case o.TEXT_NODE:var i=h.textContent.split(v),a=r(f,"textContent"),s=D(i);u.loop(s,a),p+=a.childNodes.length+1;break;case o.COMMENT_NODE:e(document.createComment(C(h.textContent,u.values)));break;case o.ELEMENT_NODE:var c=document.createElement(h.tagName.toLowerCase().replace(_,""));u.loop(h,c),e(c);var l=u.copyAttributes(c,h);u.updates=u.updates.concat(l);break;case o.TEXT_RESULT_NODE:var E=(""+(h.textContent||"")).match(g);if(E){var N=r(f,"rangeInsertion"),m=function(){var e=O(E[2],u.values);if(e!==O(E[2],u.prevValues)){var t=M(e);u.loop(t,N)}};u.updates.push(m),m(),p+=N.childNodes.length+1;break}e(document.createTextNode(h.textContent));break;case o.TEMPLATE_NODE:var T=r(f,"template");h.template.render(T),T.update(),p+=T.childNodes.length+1;break;case o.PROMISE_NODE:var y=r(f,"futureResult");h.futureResult.then(function(e){y.update();var t=M(e);return u.loop(t,y),t}),p+=y.childNodes.length+1;break;case o.ELEMENT_RESULT_NODE:var b=r(f,"element");h.element instanceof DocumentFragment||1!==b.childNodes.length?(b.childNodes.forEach(function(e){return b.removeChild(e)}),b.appendChild(h.element)):b.replaceChild(h.element,b.childNodes[0]),p+=b.childNodes.length+1}return n instanceof t&&n.update(),"continue"}())continue;if(a=f,(r=h).nodeType!==o.TEXT_NODE||r.nodeType!==o.TEXT_NODE||r.textContent!==a.textContent)if(i(h,f,_)){this.loop(h,f);var E=this.copyAttributes(f,h);this.updates=this.updates.concat(E)}else;}else n.removeChild(f),l--}return n},{html:function(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];return new(Function.prototype.bind.apply(S,[null].concat(t)))},render:function(e,t){return e.render(t)},Template:S,prepareLiterals:x,generateContainer:b,sanitize:I,replaceTokens:C}}var m=N({}),v=m.html,T=m.render,y=m.Template;e.stopNode=function(){},e.containersMap=E,e.createHtml=N,e.html=v,e.render=T,e.r=function(){return T(v.apply(void 0,arguments))},e.Template=y,Object.defineProperty(e,"__esModule",{value:!0})});
