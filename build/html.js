!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t(e.MHTML={})}(this,function(e){"use strict";function t(e,t){return this.childNodes=[],this.firstChild=null,this.lastChild=null,this.startNode=e,this.stopNode=t,e&&t?e.parentNode!==t.parentNode?this:(this.update(),this):this}t.prototype.appendChild=function(e){this.stopNode.parentNode.insertBefore(e,this.stopNode),this.update()},t.prototype.removeChild=function(e){this.stopNode.parentNode.removeChild(e),this.update()},t.prototype.replaceChild=function(e,t){t.parentNode.replaceChild(e,t),this.update()},t.prototype.extractContents=function(){var e=document.createDocumentFragment();return e.appendChild(this.startNode),this.childNodes.reduce(function(e,t){return e.appendChild(t),e},e),e.appendChild(this.stopNode),e},t.prototype.update=function(){var e=this;this.childNodes=[];for(var t=this.startNode.nextSibling;t&&t!==this.stopNode;t=t.nextSibling)t.range&&(t.range.onUpdate=function(){return e.update()}),this.childNodes.push(t);this.firstChild=this.childNodes[0],this.lastChild=this.childNodes[this.childNodes.length-1],this.onUpdate&&this.onUpdate()},t.prototype.getByIndex=function(e){};var n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};var r={},o={ELEMENT_NODE:1,ATTRIBUTE_NODE:2,TEXT_NODE:3,CDATA_SECTION_NODE:4,ENTITY_REFERENCE_NODE:5,ENTITY_NODE:6,PROCESSING_INSTRUCTION_NODE:7,COMMENT_NODE:8,DOCUMENT_NODE:9,DOCUMENT_TYPE_NODE:10,DOCUMENT_FRAGMENT_NODE:11,NOTATION_NODE:12};function i(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"";return!(!e||!t)&&(e.nodeType===t.nodeType&&(e.range==t.range&&(!(!e.tagName||!t.tagName||e.tagName.toLowerCase().replace(n,"")!==t.tagName.toLowerCase())||e.isEqualNode(t))))}function a(e){return e.replace(/[-[\]{}()*+!<=:?.\/\\^$|#\s,]/g,"\\$&")}function s(e){return e instanceof Node?"element":e instanceof N?"template":"object"==(void 0===e?"undefined":n(e))&&"function"==typeof e.then?"futureResult":"function"==typeof e?"function":"text"}function u(e,t,n,r){""!==r&&t in e?e[t]=n:e.setAttribute(t,n)}var p="modulor_stop_node_"+ +new Date;function c(e){e.nodeStopper=p}var h="{modulor_html_chunk_"+ +new Date+":",d="}",l=new DOMParser,f="modulor_sanitize_node_"+ +new Date+":",m=new RegExp("<([ /])?("+["table","tr","td"].join("|")+")([ ][^]>)?","igm");function N(e){return this.PREFIX=e.PREFIX||h,this.POSTFIX=e.POSTFIX||d,this.parser=e.parser||l,this.splitChunkRegex=new RegExp(this.getTokenRegExp(),"ig"),this.findChunksRegex=new RegExp(this.getTokenRegExp(!0),"ig"),this.replaceChunkRegex=new RegExp(this.getTokenRegExp(!0),"ig"),this.matchChunkRegex=new RegExp("^"+this.getTokenRegExp(!0)+"$"),this.sanitizeNodePrefix=e.SANITIZE_NODE_PREFIX||f,this.updates=[],this}var g=new Map;N.prototype.parse=function(e){this.prevValues=[];for(var t=arguments.length,n=Array(t>1?t-1:0),o=1;o<t;o++)n[o-1]=arguments[o];this.values=n,this.template=this.prepareLiterals(e),this.templateId=function(e){for(var t=5381,n=e.length;n;)t=33*t^e.charCodeAt(--n);return t>>>0}(this.template);var i=r[this.templateId];return void 0===i?(this.container=this.generateContainer(this.sanitize(this.template)),r[this.templateId]=this.container):this.container=i,this},N.prototype.getChunkById=function(e){return(arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.values)[e]},N.prototype.processTextNodeChunks=function(e){var t=this;return e.reduce(function(e,n){if(!(""+n).length)return e;var r=n.match(t.matchChunkRegex),o=r?t.getChunkById(r[2]):n;if(void 0===o)return e;var i=s(o);if("text"!==i){var a=document.createComment("");return a.isSpecialChunk=!0,a[i]=o,a.chunkType=i,a.templateId=t.templateId,a.chunkId=r[2],e.concat(a)}return e.concat(o)},[])},N.prototype.copyTextNodeChunks=function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:document.createDocumentFragment();return[].concat(e).reduce(function(e,n){if(n.isSpecialChunk)return e.appendChild(n),e;var r=s(n);if("text"===r)e.appendChild(document.createTextNode(n));else{var o=document.createComment("");o[r]=n,o.isSpecialChunk=!0,o.chunkType=r,o.templateId=t.templateId,e.appendChild(o)}return e},n)},N.prototype.copyAttributes=function(e,t){for(var n=this,r=t.attributes,o=e.attributes,i=[],a={},p=function(t){var o=r[t],p=o.name,c=o.value,h=p.match(n.splitChunkRegex),d=c.match(n.splitChunkRegex);if(a[p]=!0,!h&&!d)return u(e,p,c),"continue";if("class"===p)return e.className="",c.split(" ").forEach(function(t){t.match(n.splitChunkRegex)?i.push(function(){var r=n.replaceTokens(t),o=n.replaceTokens(t,n.prevValues);o!==r&&(o&&e.classList.remove(o),r&&e.classList.add(r))}):e.classList.add(t)}),"continue";var l=p.match(n.matchChunkRegex),f=c.match(n.matchChunkRegex);i.push(function(){var t=l?n.getChunkById(l[2]):n.replaceTokens(p),r=l?n.getChunkById(l[2],n.prevValues):n.replaceTokens(p,n.prevValues),o=f?n.getChunkById(f[2]):n.replaceTokens(c),i=f?n.getChunkById(f[2],n.prevValues):n.replaceTokens(c,n.prevValues);t===r&&o===i||(t!==r&&e.removeAttribute(r),t&&("function"!==s(t)?"futureResult"!==s(o)?u(e,t,o,c):o.then(function(n){return u(e,t,n)}):t(e,o)))})},c=0;c<r.length;c++)p(c);for(c=0;c<o.length;c++){var h=o[c].name;a[h]||e.removeAttribute(h)}return i.forEach(function(e){return e()}),i},N.prototype.loop=function(e,n,r){for(var a,s,u=this,c=0,h=0;;c++){if(c>1e3){console.log("too much recursion");break}var d=e.childNodes[c],l=n.childNodes[c+h];if(!d&&!l)break;if(d){if(!l||!i(d,l,this.sanitizeNodePrefix))if("continue"===function(){var e=function(e,t){return function(n){return t?e.replaceChild(n,t):e.appendChild(n)}}(n,l),r=function(n,r){if(n&&n.range&&n.replacementType===r&&n.templateId===u.templateId)return n.range;var o=new t(document.createTextNode(""),document.createTextNode("")),i=o.startNode;return i.range=o,i.replacementType=r,i.templateId=u.templateId,e(o.extractContents()),o};switch(d.nodeType){case o.TEXT_NODE:var i=d.textContent.split(u.splitChunkRegex);if(1===i.length){e(document.createTextNode(d.textContent));break}var a=r(l,"textContent"),s=function(){var e=u.processTextNodeChunks(i),t=u.copyTextNodeChunks(e);u.loop(t,a)};u.updates.push(s),s(),h+=a.childNodes.length+1;break;case o.COMMENT_NODE:if(d.isSpecialChunk){var p=d.chunkType,c=r(l,p);if("futureResult"===p){c.update(),d.futureResult.then(function(e){c.update();var t=u.copyTextNodeChunks(e);return u.loop(t,c),t}),h+=c.childNodes.length+1;break}if("template"===p){d.template.render(c),c.update(),h+=c.childNodes.length+1;break}if("element"===p){d.element instanceof DocumentFragment||1!==c.childNodes.length?(c.childNodes.forEach(function(e){return c.removeChild(e)}),c.appendChild(d.element)):c.childNodes[0]!==d.element&&c.replaceChild(d.element,c.childNodes[0]),h+=c.childNodes.length+1;break}}e(document.createComment(u.replaceTokens(d.textContent)));break;case o.ELEMENT_NODE:var f=document.createElement(d.tagName.toLowerCase().replace(u.sanitizeNodePrefix,""));u.loop(d,f),e(f);var m=u.copyAttributes(f,d);u.updates=u.updates.concat(m)}return n instanceof t&&n.update(),"continue"}())continue;if(s=l,(a=d).nodeType!==o.TEXT_NODE||a.nodeType!==o.TEXT_NODE||a.textContent!==s.textContent)if(i(d,l,this.sanitizeNodePrefix)){l.nodeStopper!==p&&this.loop(d,l);var f=this.copyAttributes(l,d);this.updates=this.updates.concat(f)}else;}else n.removeChild(l),c--}return n},N.prototype.render=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:document.createDocumentFragment(),t=g.get(e);if((t||{}).templateId!==this.templateId)return c(e),g.set(e,{templateId:this.templateId,update:this.update.bind(this)}),this.loop(this.container,e);t.update(this.values)},N.prototype.update=function(e){this.prevValues=this.values,this.values=e,this.updates.forEach(function(e){return e()})},N.prototype.generateContainer=function(e){return this.parser.parseFromString(e,"text/html").body},N.prototype.sanitize=function(e){return e.replace(m,"<$1"+this.sanitizeNodePrefix+"$2")},N.prototype.prepareLiterals=function(e){var t,n=this,r=(t=e,Array.isArray(t)?t:Array.from(t)),o=r[0];return r.slice(1).reduce(function(e,t,r){var o=n.generateTokenName(r);return e.concat(o).concat(t)},o)},N.prototype.generateTokenName=function(e){return""+this.PREFIX+e+this.POSTFIX},N.prototype.replaceTokens=function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.values;return e.replace(this.replaceChunkRegex,function(e,r,o){return t.getChunkById(o,n)||""})},N.prototype.getTokenRegExp=function(e){var t=(e?"(":"")+"\\d+"+(e?")":"");return"("+a(this.PREFIX)+t+a(this.POSTFIX)+")"};var C=function(){var e;return(e=new N({})).parse.apply(e,arguments)},v=function(e,t){return e.render(t)};e.stopNode=c,e.Template=N,e.containersMap=g,e.html=C,e.render=v,e.r=function(){return v(C.apply(void 0,arguments))},Object.defineProperty(e,"__esModule",{value:!0})});
