!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t(e.MHTML={})}(this,function(e){"use strict";function t(e,t){return this.childNodes=[],this.firstChild=null,this.lastChild=null,this.startNode=e,this.stopNode=t,e&&t?e.parentNode!==t.parentNode?this:(this.update(),this):this}t.prototype.appendChild=function(e){this.stopNode.parentNode.insertBefore(e,this.stopNode),this.update()},t.prototype.removeChild=function(e){this.stopNode.parentNode.removeChild(e),this.update()},t.prototype.replaceChild=function(e,t){t.parentNode.replaceChild(e,t),this.update()},t.prototype.extractContents=function(){var e=document.createDocumentFragment();return e.appendChild(this.startNode),this.childNodes.reduce(function(e,t){return e.appendChild(t),e},e),e.appendChild(this.stopNode),e},t.prototype.update=function(){var e=this;this.childNodes=[];for(var t=this.startNode.nextSibling;t&&t!==this.stopNode;t=t.nextSibling)t.range&&(t.range.onUpdate=function(){return e.update()}),this.childNodes.push(t);this.firstChild=this.childNodes[0],this.lastChild=this.childNodes[this.childNodes.length-1],this.onUpdate&&this.onUpdate()},t.prototype.getByIndex=function(e){};var n=function(){return function(e,t){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return function(e,t){var n=[],r=!0,o=!1,a=void 0;try{for(var i,u=e[Symbol.iterator]();!(r=(i=u.next()).done)&&(n.push(i.value),!t||n.length!==t);r=!0);}catch(e){o=!0,a=e}finally{try{!r&&u.return&&u.return()}finally{if(o)throw a}}return n}(e,t);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};var o={},a={TEMPLATE_NODE:-1,TEXT_RESULT_NODE:-2,PROMISE_NODE:-3,ELEMENT_RESULT_NODE:-4,CHUNK_NODE:-5,ELEMENT_NODE:1,ATTRIBUTE_NODE:2,TEXT_NODE:3,CDATA_SECTION_NODE:4,ENTITY_REFERENCE_NODE:5,ENTITY_NODE:6,PROCESSING_INSTRUCTION_NODE:7,COMMENT_NODE:8,DOCUMENT_NODE:9,DOCUMENT_TYPE_NODE:10,DOCUMENT_FRAGMENT_NODE:11,NOTATION_NODE:12};function i(e,t){return!(!e||!t)&&(e.nodeType===t.nodeType&&(e.range==t.range&&!(!e.tagName||!t.tagName||e.tagName.toLowerCase()!==t.tagName.toLowerCase())))}function u(e){return void 0!==e}function c(e){return e.replace(/[-[\]{}()*+!<=:?.\/\\^$|#\s,]/g,"\\$&")}function s(e){return e instanceof Node?"element":e instanceof g?"template":!(t=e)||"object"!==(void 0===t?"undefined":r(t))&&"function"!=typeof t||"function"!=typeof t.then?"function"==typeof e?"function":"text":"futureResult";var t}function d(e,t,n){""!==n&&"style"!==t&&t in e?e[t]=n:e.setAttribute(t,n)}var l="{modulor_html_chunk_"+ +new Date+":",p="}",h=new DOMParser,f="modulor_sanitize_node_"+ +new Date+":",N=new RegExp("<([ /])?("+["table","tr","td"].join("|")+")([ ][^]>)?","igm"),E=new Map;function m(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},r=e.PREFIX||l,m=e.POSTFIX||p,v=e.parser||h,T=new RegExp(I(),"ig"),y=new RegExp(I(),"ig"),g=new RegExp(I(!0),"ig"),_=new RegExp("^"+I(!0)+"$"),C=e.SANITIZE_NODE_PREFIX||f;function O(e){return(arguments.length>1&&void 0!==arguments[1]?arguments[1]:[])[e]}function D(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];return e.replace(g,function(e,n,r){var o=O(r,t);return u(o)?o:""})}function b(e){var t={nodeType:e.nodeType,textContent:e.textContent,attributes:[],childNodes:[]};e.tagName&&(t.tagName=e.tagName.toLowerCase().replace(C,"").toUpperCase());for(var n=e.childNodes||[],r=0;r<n.length;r++){if(n[r].nodeType!==a.TEXT_NODE)t.childNodes.push(b(n[r]));else n[r].textContent.split(T).filter(function(e){return!!e}).forEach(function(e){var n=e.match(_);n?t.childNodes.push({nodeType:a.CHUNK_NODE,matchIndex:n[2]}):t.childNodes.push({nodeType:a.TEXT_RESULT_NODE,textContent:e})})}for(var o=e.attributes||[],i=0;i<o.length;i++){var u=o[i],c=u.name,s=u.value;t.attributes.push({name:c,value:s})}return t}function x(e){return b(v.parseFromString(e,"text/html").body)}function R(e){var t,n=(t=e,Array.isArray(t)?t:Array.from(t)),o=n[0];return n.slice(1).reduce(function(e,t,n){var o=function(e){return""+r+e+m}(n);return e.concat(o).concat(t)},o)}function I(e){var t=(e?"(":"")+"\\d+"+(e?")":"");return"("+c(r)+t+c(m)+")"}function S(e){return e.replace(N,"<$1"+C+"$2")}function M(e){return{childNodes:[].concat(e).reduce(function(e,t){if(!u(t))return e;var n=s(t),r={};return"text"===n&&(r.nodeType=a.TEXT_RESULT_NODE,r.textContent=t),"element"===n&&(r.nodeType=a.ELEMENT_RESULT_NODE),"template"===n&&(r.nodeType=a.TEMPLATE_NODE),"futureResult"===n&&(r.nodeType=a.PROMISE_NODE),r[n]=t,e.concat(r)},[])}}function L(e,t){for(var n=t.attributes,r=e.attributes,o=[],a={},i=function(t){var r=n[t],i=r.name,u=r.value,c=i.match(y),l=u.match(y);if(a[i]=!0,!c&&!l)return d(e,i,u),"continue";if("class"===i)return e.className="",u.split(" ").forEach(function(t){t.match(y)?o.push(function(n,r){var o=D(t,n),a=D(t,r);a!==o&&(a&&e.classList.remove(a),o&&e.classList.add(o))}):e.classList.add(t)}),"continue";var p=i.match(_),h=u.match(_);o.push(function(t,n){var r=p?O(p[2],t):D(i,t),o=p?O(p[2],n):D(i,n),a=h?O(h[2],t):D(u,t),c=h?O(h[2],n):D(u,n);r===o&&a===c||(r!==o&&e.removeAttribute(o),r&&("function"!==s(r)?"futureResult"!==s(a)?d(e,r,a):a.then(function(t){return d(e,r,t)}):r(e,a)))})},u=0;u<n.length;u++)i(u);for(u=0;u<r.length;u++){var c=r[u].name;a[c]||e.removeAttribute(c)}return o}function A(e,r){for(var o,u,c=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},s=[],d=c.useDocFragment?document.createDocumentFragment():r,l=e.childNodes,p=function(e){return e?function(t){return r.replaceChild(t,e)}:function(e){return d.appendChild(e)}},h=0,f=0;;h++){var N=l[h],E=r.childNodes[h+f];if(!N&&!E)break;if(N){if(!E||!i(N,E))if("continue"===function(){var e=p(E),o=function(n,r){if(n&&n.range&&n.replacementType===r)return n.range;var o=new t(document.createTextNode(""),document.createTextNode("")),a=o.startNode;return a.range=o,a.replacementType=r,e(o.extractContents()),o};switch(N.nodeType){case a.COMMENT_NODE:var i=document.createComment(""),u=N.textContent;e(i),s.push(function(e,t){i.textContent=D(u,e)});break;case a.ELEMENT_NODE:var c=document.createElement(N.tagName.toLowerCase());s=s.concat(A(N,c)[0]).concat(L(c,N)),e(c);break;case a.TEXT_NODE:case a.TEXT_RESULT_NODE:e(document.createTextNode(N.textContent));break;case a.CHUNK_NODE:var d=N.matchIndex,l=o(E,"chunkRange");s.push(function(e,t){var r=O(d,e);if(r!==O(d,t)){var o=A(M(r),l,{useDocFragment:!0}),a=n(o,2);a[0],(0,a[1])()}}),f+=l.childNodes.length+1;break;case a.TEMPLATE_NODE:var h=o(E,"template");N.template.render(h),h.update(),f+=h.childNodes.length+1;break;case a.PROMISE_NODE:var m=o(E,"futureResult");N.futureResult.then(function(e){m.update();var t=M(e),r=A(t,m,{useDocFragment:!0}),o=n(r,2);o[0];return(0,o[1])(),t}),f+=m.childNodes.length+1;break;case a.ELEMENT_RESULT_NODE:var v=o(E,"element");N.element instanceof DocumentFragment||1!==v.childNodes.length?(v.childNodes.forEach(function(e){return v.removeChild(e)}),v.appendChild(N.element)):v.replaceChild(N.element,v.childNodes[0]),f+=v.childNodes.length+1}return r instanceof t&&r.update(),"continue"}())continue;u=E,((o=N).nodeType!==a.TEXT_NODE||o.nodeType!==a.TEXT_NODE||o.textContent!==u.textContent)&&i(N,E)&&(s=s.concat(A(N,E)[0]).concat(L(E,N)))}else r.removeChild(E),h--}return[s,function(){return c.useDocFragment?r.appendChild(d):void 0}]}function w(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];this.prevValues=[];for(var t=arguments.length,n=Array(t>1?t-1:0),a=1;a<t;a++)n[a-1]=arguments[a];if(this.values=n,!e.length)return this;this.templateId=function(e){for(var t=5381,n=e.length;n;)t=33*t^e.charCodeAt(--n);return t>>>0}(e.join(r+m));var i=o[this.templateId];if(u(i))this.container=i;else{var c=R(e);this.container=x(S(c)),o[this.templateId]=this.container}return this.updates=[],this}return w.prototype.render=function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:document.createDocumentFragment(),r=E.get(t);if((r||{}).templateId!==this.templateId){var o=A(this.container,t,{useDocFragment:!0}),a=n(o,2),i=a[0],u=a[1];return i.forEach(function(t){return t(e.values,e.prevValues)}),u(),this.updates=i,E.set(t,{templateId:this.templateId,update:this.update.bind(this)}),t}r.update(this.values)},w.prototype.update=function(e){var t=this;this.prevValues=this.values,this.values=e,this.updates.forEach(function(e){return e(t.values,t.prevValues)})},{html:function(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];return new(Function.prototype.bind.apply(w,[null].concat(t)))},render:function(e,t){return e.render(t)},Template:w,prepareLiterals:R,generateContainer:x,sanitize:S,replaceTokens:D,copyAttributes:L,morph:A,processNode:b}}var v=m({}),T=v.html,y=v.render,g=v.Template;e.stopNode=function(){},e.containersMap=E,e.createHtml=m,e.html=T,e.render=y,e.r=function(){return y(T.apply(void 0,arguments))},e.Template=g,Object.defineProperty(e,"__esModule",{value:!0})});
