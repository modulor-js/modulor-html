!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t(e.MHTML={})}(this,function(e){"use strict";function t(e,t){return this.childNodes=[],this.firstChild=null,this.lastChild=null,this.startNode=e,this.stopNode=t,e&&t?e.parentNode!==t.parentNode?this:(this.update(),this):this}t.prototype.appendChild=function(e){this.stopNode.parentNode.insertBefore(e,this.stopNode),this.update()},t.prototype.removeChild=function(e){this.stopNode.parentNode.removeChild(e),this.update()},t.prototype.replaceChild=function(e,t){t.parentNode.replaceChild(e,t),this.update()},t.prototype.extractContents=function(){var e=document.createDocumentFragment();return e.appendChild(this.startNode),this.childNodes.reduce(function(e,t){return e.appendChild(t),e},e),e.appendChild(this.stopNode),e},t.prototype.update=function(){var e=this;this.childNodes=[];for(var t=this.startNode.nextSibling;t&&t!==this.stopNode;t=t.nextSibling)t.range&&(t.range.onUpdate=function(){return e.update()}),this.childNodes.push(t);this.firstChild=this.childNodes[0],this.lastChild=this.childNodes[this.childNodes.length-1],this.onUpdate&&this.onUpdate()},t.prototype.getByIndex=function(e){};var n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},r=function(){return function(e,t){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return function(e,t){var n=[],r=!0,o=!1,i=void 0;try{for(var a,u=e[Symbol.iterator]();!(r=(a=u.next()).done)&&(n.push(a.value),!t||n.length!==t);r=!0);}catch(e){o=!0,i=e}finally{try{!r&&u.return&&u.return()}finally{if(o)throw i}}return n}(e,t);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}();var o={},i={ELEMENT_NODE:1,ATTRIBUTE_NODE:2,TEXT_NODE:3,CDATA_SECTION_NODE:4,ENTITY_REFERENCE_NODE:5,ENTITY_NODE:6,PROCESSING_INSTRUCTION_NODE:7,COMMENT_NODE:8,DOCUMENT_NODE:9,DOCUMENT_TYPE_NODE:10,DOCUMENT_FRAGMENT_NODE:11,NOTATION_NODE:12};function a(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"";return!(!e||!t)&&(e.nodeType===t.nodeType&&(e.range==t.range&&(!(!e.tagName||!t.tagName||e.tagName.toLowerCase().replace(n,"")!==t.tagName.toLowerCase())||e.isEqualNode(t))))}function u(e){return e.replace(/[-[\]{}()*+!<=:?.\/\\^$|#\s,]/g,"\\$&")}function p(e){return e instanceof Node?"element":e instanceof Promise?"futureResult":e instanceof y?"template":e instanceof Function?"function":"text"}function s(e,t,n,r){""!==r&&t in e?e[t]=n:e.setAttribute(t,n)}var c="modulor_stop_node_"+ +new Date;function d(e){e.nodeStopper=c}var h="{modulor_html_chunk_"+ +new Date+":",l="}",f=new DOMParser,m="modulor_sanitize_node_"+ +new Date+":",N=new RegExp("<([ /])?("+["table","tr","td"].join("|")+")([ ][^]>)?","igm");function y(e){return this.PREFIX=e.PREFIX||h,this.POSTFIX=e.POSTFIX||l,this.parser=e.parser||f,this.replaceChunkRegex=new RegExp(this.getTokenRegExp(),"ig"),this.matchChunkRegex=new RegExp("^"+this.getTokenRegExp(!0)+"$"),this.sanitizeNodePrefix=e.SANITIZE_NODE_PREFIX||m,this}y.prototype.parse=function(){var e=this.prepareLiterals.apply(this,arguments),t=r(e,2);this.template=t[0],this.dataMap=t[1],this.templateId=function(e){for(var t=5381,n=e.length;n;)t=33*t^e.charCodeAt(--n);return t>>>0}(this.template);var n=o[this.templateId];return void 0===n?(this.container=this.generateContainer(this.sanitize(this.template)),o[this.templateId]=this.container):this.container=n,this},y.prototype.processTextNodeChunks=function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.dataMap;return e.reduce(function(e,r){if(!(""+r).length)return e;var o=r.match(t.matchChunkRegex),i=o?n[r]:r;if(void 0===i)return e;var a=p(i);if("text"!==a){var u=document.createComment("");return u.isSpecialChunk=!0,u[a]=i,u.chunkType=a,u.templateId=t.templateId,u.chunkId=o[2],e.concat(u)}return e.concat(i)},[])},y.prototype.copyTextNodeChunks=function(e){var t=this,n=(arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.dataMap,arguments.length>2&&void 0!==arguments[2]?arguments[2]:document.createDocumentFragment());return[].concat(e).reduce(function(e,n){if(n.isSpecialChunk)return e.appendChild(n),e;var r=p(n);if("text"===r)e.appendChild(document.createTextNode(n));else{var o=document.createComment("");o[r]=n,o.isSpecialChunk=!0,o.chunkType=r,o.templateId=t.templateId,e.appendChild(o)}return e},n)},y.prototype.copyAttributes=function(e,t){var r=this,o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:this.dataMap,i=[],a=t.attributes;if(a.length){for(var u=function(t){var n=a[t],u=n.name,c=n.value,d=r.matchChunkRegex.test(u)?o[u]:r.replaceTokens(u),h=r.matchChunkRegex.test(c)?o[c]:r.replaceTokens(c);return""===d?{v:void 0}:"function"===p(d)?(d(e,h),"continue"):(i.push(d),"futureResult"===p(h)?(h.then(function(t){return s(e,d,t)}),"continue"):void s(e,d,h,c))},c=0;c<a.length;c++){var d=u(c);switch(d){case"continue":continue;default:if("object"===(void 0===d?"undefined":n(d)))return d.v}}for(var h=e.attributes,l=0;l<h.length;l++){var f=h[l].name;~i.indexOf(f)||e.removeAttribute(f)}}},y.prototype.loop=function(e,n,r){for(var o,u,p=this,s=0,d=0;;s++){if(s>1e3){console.log("too much recursion");break}var h=e.childNodes[s],l=n.childNodes[s+d];if(!h&&!l)break;if(h){if(!l||!a(h,l,this.sanitizeNodePrefix))if("continue"===function(){var e=function(e,t){return function(n){return t?e.replaceChild(n,t):e.appendChild(n)}}(n,l),r=function(n,r){if(n&&n.range&&n.replacementType===r&&n.templateId===p.templateId)return n.range;var o=new t(document.createTextNode(""),document.createTextNode("")),i=o.startNode;return i.range=o,i.replacementType=r,i.templateId=p.templateId,e(o.extractContents()),o};switch(h.nodeType){case i.TEXT_NODE:var o=h.textContent.split(p.replaceChunkRegex);if(1===o.length){e(document.createTextNode(h.textContent));break}var a=r(l,"textContent"),u=p.processTextNodeChunks(o),s=p.copyTextNodeChunks(u);p.loop(s,a),d+=a.childNodes.length+1;break;case i.COMMENT_NODE:if(h.isSpecialChunk){var c=h.chunkType,f=r(l,c);if("futureResult"===c){f.update(),h.futureResult.then(function(e){f.update();var t=p.copyTextNodeChunks(e);return p.loop(t,f),t}),d+=f.childNodes.length+1;break}if("template"===c){h.template.render(f),d+=f.childNodes.length+1;break}if("element"===c){var m=document.createDocumentFragment();m.appendChild(h.element),p.loop(m,f),d+=f.childNodes.length+1;break}}e(document.createComment(p.replaceTokens(h.textContent)));break;case i.ELEMENT_NODE:var N=document.createElement(h.tagName.toLowerCase().replace(p.sanitizeNodePrefix,""));p.loop(h,N),e(N),p.copyAttributes(N,h)}return"continue"}())continue;u=l,((o=h).nodeType!==i.TEXT_NODE||o.nodeType!==i.TEXT_NODE||o.textContent!==u.textContent)&&a(h,l,this.sanitizeNodePrefix)&&(l.nodeStopper!==c&&this.loop(h,l),this.copyAttributes(l,h))}else n.removeChild(l),s--}return n},y.prototype.render=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:document.createDocumentFragment();return d(e),this.loop(this.container,e)},y.prototype.generateContainer=function(e){return this.parser.parseFromString(e,"text/html").body},y.prototype.sanitize=function(e){return e.replace(N,"<$1"+this.sanitizeNodePrefix+"$2")},y.prototype.prepareLiterals=function(e){for(var t=this,n=arguments.length,o=Array(n>1?n-1:0),i=1;i<n;i++)o[i-1]=arguments[i];var a,u=(a=e,Array.isArray(a)?a:Array.from(a)),p=u[0];return u.slice(1).reduce(function(e,n,i){var a=r(e,2),u=a[0],p=a[1],s=t.generateTokenName(i);return p[s]=o[i],[u.concat(s).concat(n),p]},[p,{}])},y.prototype.generateTokenName=function(e){return""+this.PREFIX+e+this.POSTFIX},y.prototype.replaceTokens=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.dataMap;return e.replace(this.replaceChunkRegex,function(e,n){return t[e]})},y.prototype.getTokenRegExp=function(e){var t=(e?"(":"")+"\\d+"+(e?")":"");return"("+u(this.PREFIX)+t+u(this.POSTFIX)+")"};var v=function(){var e;return(e=new y({})).parse.apply(e,arguments)},T=function(e,t){return e.render(t)};e.stopNode=d,e.Template=y,e.html=v,e.render=T,e.r=function(){return T(v.apply(void 0,arguments))},Object.defineProperty(e,"__esModule",{value:!0})});
